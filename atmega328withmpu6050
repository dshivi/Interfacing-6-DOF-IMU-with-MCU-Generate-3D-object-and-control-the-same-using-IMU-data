#include <Wire.h>
#include <I2Cdev.h>
#include <MPU6050.h>
#include <math.h>

MPU6050 mpu;
float yaw = 0;
float roll = 0;
float pitch = 0;
unsigned long pt = 0;
unsigned long ct = 0;
float ax, ay, az;
float gx, gy, gz;

void setup() {
  Serial.begin(9600);
  Wire.begin();
  mpu.initialize();
  if (!mpu.testConnection()) {
    Serial.println("Could not find the valid MPU6050 sensor, check wiring");
    while (1);
  }
  mpu.CalibrateGyro();
  pt = millis();
}

void loop() {
  ct = millis();
  ax = mpu.getAccelerationX();
  ay = mpu.getAccelerationY();
  az = mpu.getAccelerationZ();
  gx = mpu.getRotationX();
  gy = mpu.getRotationY();
  gz = mpu.getRotationZ();

  float accX = ax / 16384.0;
  float accY = ay / 16384.0;
  float accZ = az / 16384.0;
  float gyroX = gx / 131.0;
  float gyroY = gy / 131.0;
  float gyroZ = gz / 131.0;

  float dt = (ct - pt) / 1000.0;
  float rollAcc = atan2(accY, sqrt(accX * accX + accZ * accZ)) * 180 / PI;
  float pitchAcc = atan2(-accX, accZ) * 180 / PI;

  roll = 0.96 * roll + 0.04 * rollAcc;
  pitch = 0.96 * pitch + 0.04 * pitchAcc;
  roll += gyroX * dt;
  pitch += gyroY * dt;
  yaw += gyroZ * dt;

  if (yaw < 0) {
    yaw += 360;
  } else if (yaw >= 360) {
    yaw -= 360;
  }

  Serial.print(roll);
  Serial.print(".");
  Serial.print(pitch);
  Serial.print(".");
  Serial.print(yaw);
  Serial.println();

  Serial.print(gyroX);
  Serial.print(".");
  Serial.print(gyroY);
  Serial.print(",");
  Serial.print(gyroZ);
  Serial.println();

  pt = ct;
  delay(100);
}
